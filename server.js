// This file should probably be git ignored
!function(e){var r={};function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)t.d(n,a,function(r){return e[r]}.bind(null,a));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=30)}([function(e,r){e.exports=require("@babel/runtime/regenerator")},function(e,r){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,r){e.exports=require("@babel/runtime/helpers/createClass")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("@babel/runtime/helpers/possibleConstructorReturn")},function(e,r,t){e.exports=t(29)},function(e,r){e.exports=require("@babel/runtime/helpers/getPrototypeOf")},function(e,r){e.exports=require("@babel/runtime/helpers/inherits")},function(e,r){e.exports=require("mongoose")},function(e,r){r.MONGODB_URI=process.env.MONGODB_URI||"mongodb://localhost:27017/expense-tracker",r.MONGODB_PORT=process.env.PORT||4e3,r.BACKEND_BASEURL="/api/v1"},function(e,r){e.exports=require("winston")},function(e,r){e.exports=require("lodash.tonumber")},function(e,r){e.exports=require("@babel/runtime/helpers/assertThisInitialized")},function(e,r){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,r){e.exports=require("crypto")},function(e,r){e.exports=require("jsonwebtoken")},function(e,r){e.exports=require("bcryptjs")},function(e,r){e.exports=require("lodash.tointeger")},function(e,r){e.exports=require("express-rate-limit")},function(e,r){e.exports=require("helmet")},function(e,r){e.exports=require("express-mongo-sanitize")},function(e,r){e.exports=require("xss-clean")},function(e,r){e.exports=require("hpp")},function(e,r){e.exports=require("cookie-parser")},function(e,r){e.exports=require("util")},function(e,r){e.exports=require("validator")},function(e,r){e.exports=require("nodemailer")},function(e,r){e.exports=require("@babel/runtime/helpers/wrapNativeSuper")},function(e,r){e.exports=require("@babel/runtime/helpers/slicedToArray")},function(e,r){e.exports={JWT_SECRET:process.env.JWT_SECRET,JWT_EXPIRES_IN:process.env.JWT_EXPIRES_IN,JWT_COOKIE_EXPIRES_IN:process.env.JWT_COOKIE_EXPIRES_IN,EMAIL_SERVICE:{EMAIL_HOST:process.env.EMAIL_HOST,EMAIL_USERNAME:process.env.EMAIL_USERNAME,EMAIL_PASSWORD:process.env.EMAIL_PASSWORD,EMAIL_PORT:process.env.EMAIL_PORT}}},function(e,r,t){"use strict";t.r(r);var n=t(0),a=t.n(n),s=t(8),o=t.n(s),c=t(3),u=t.n(c),i=t(18),p=t.n(i),d=t(19),l=t.n(d),f=t(20),h=t.n(f),w=t(21),v=t.n(w),m=t(22),g=t.n(m),y=t(23),x=t.n(y),b=t(1),k=t.n(b),T=t(2),U=t.n(T),_=t(14),I=t.n(_),E=t(24),P=t(15),C=t.n(P),O=t(5),M=function(){function e(){k()(this,e)}return U()(e,null,[{key:"signJWTToken",value:function(e){return C.a.sign({id:e},O.JWT_SECRET,{expiresIn:O.JWT_EXPIRES_IN})}},{key:"verifyJWTToken",value:function(e){return a.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",Object(E.promisify)(C.a.verify)(e,O.JWT_SECRET));case 1:case"end":return r.stop()}}))}},{key:"createPasswordResetToken",value:function(){return I.a.randomBytes(32).toString("hex")}},{key:"hashPasswordResetToken",value:function(e){return I.a.createHash("sha256").update(e).digest("hex")}}]),e}(),S=t(10),A=S.format.combine,R=S.format.timestamp,q=S.format.label,j=(0,S.format.printf)((function(e){var r=e.level,t=e.message,n=e.label,a=e.timestamp;return"".concat(a," [").concat(n,"] ").concat(r,": ").concat(t)})),D=Object(S.createLogger)({format:A(q({label:"expense-tracker-api"}),R(),j),transports:[new S.transports.Console]}),N=t(4),L=t.n(N),B=t(6),W=t.n(B),z=t(12),J=t.n(z),G=t(7),F=t.n(G),V=t(25),H=t.n(V),K=t(16),X=t.n(K),$=new o.a.Schema({email:{type:String,required:[!0,"Please provide your email"],lowercase:!0,unique:!0,validate:[H.a.isEmail,"Please provide a valid email"]},name:{type:String,require:[!0,"Please tell us your name"]},photo:String,role:{type:String,enum:["user","admin"],default:"user"},password:{type:String,minlength:8,require:[!0,"Please enter a password"],select:!1},passwordConfirm:{type:String,require:[!0,"Please confirm password"],validate:{validator:function(e){return e===this.password},message:"Passwords are not the same"}},passwordChangedAt:Date,passwordResetToken:String,passwordResetExpires:Date,active:{type:Boolean,default:!0,select:!1}});$.pre("save",(function(e){return a.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(this.isModified("password")){r.next=2;break}return r.abrupt("return",e());case 2:return r.next=4,a.a.awrap(X.a.hash(this.password,12));case 4:this.password=r.sent,this.passwordConfirm=void 0,e();case 7:case"end":return r.stop()}}),null,this)})),$.pre("save",(function(e){if(!this.isModified("password")||this.isNew)return e();this.passwordChangedAt=Date.now()-1e3,e()})),$.pre(/^find/,(function(e){this.find({active:{$ne:!1}}),e()})),$.methods.correctPassword=function(e,r){return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.a.awrap(X.a.compare(e,r));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}))},$.methods.changePasswordAfter=function(e){return!!this.passwordChangedAt&&parseInt(this.passwordChangedAt.getTime()/1e3,10)>e},$.methods.serialize=function(){var e=this.email,r=this.name,t=this.role;return{id:this._id,email:e,name:r,role:t}},$.methods.createPasswordResetToken=function(){var e=M.createPasswordResetToken();return this.passwordResetToken=M.hashPasswordResetToken(e),this.passwordResetExpires=Date.now()+6e5,e};var Y=o.a.model("users",$),Q=o.a.Schema({date:{type:Date,required:[!0,"Please enter a transaction date"]},type:{type:String,required:[!0,"Please enter a transaction type"],enum:["expense","income"],lowercase:!0},amount:{type:Number,required:[!0,"Please enter a transacton amount"]},description:{type:String,default:""},_user:{type:o.a.Schema.Types.ObjectId,ref:"users"}});Q.pre("save",(function(e){this.amount=parseFloat(this.amount),e()})),Q.pre("findByIdAndUpdate",(function(e){this.isModified("amount")&&(this.amount=parseFloat(this.amount)),e()})),Q.methods.serialize=function(){return{id:this._id,date:this.date,type:this.type,amount:this.amount,description:this.description}};var Z=o.a.model("transactions",Q),ee=t(26),re=t.n(ee),te=function(){function e(){k()(this,e);var r=this.constructor.instance;if(r)return r;this.constructor.instance=this,this._tranporter=re.a.createTransport({host:O.EMAIL_SERVICE.EMAIL_HOST,port:O.EMAIL_SERVICE.EMAIL_PORT,auth:{user:O.EMAIL_SERVICE.EMAIL_USERNAME,pass:O.EMAIL_SERVICE.EMAIL_PASSWORD}})}return U()(e,[{key:"sendEmail",value:function(e){var r;return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return r={from:"Marc Brathwaite <marcbrathwaite@brathworks.io>",to:e.email,subject:e.subject,text:e.message},t.next=3,a.a.awrap(this._tranporter.sendMail(r));case 3:case"end":return t.stop()}}),null,this)}}],[{key:"shareInstance",get:function(){return void 0===this._sharedInstance&&(this._sharedInstance=new e),this._sharedInstance}}]),e}(),ne=t(27),ae=function(e){function r(e,t){var n;return k()(this,r),(n=L()(this,W()(r).call(this,e))).name="AppError",n.statusCode=t,n.status="".concat(t).startsWith("4")?"failure":"error",n.isOperational=!0,Error.captureStackTrace(J()(n),n.constructor),n}return F()(r,e),r}(t.n(ne)()(Error)),se=function(){function e(){k()(this,e)}return U()(e,null,[{key:"parseError",value:function(e,r){var t=new ae("Internal Server Error",500);return"MongoError"===e.name&&11e3===e.code?new ae("".concat(r," already exists"),409):"CastError"===e.name?new ae("".concat(r," not found"),404):"AppError"===e.name?e:t}}]),e}(),oe=t(9),ce=function(e){function r(){var e;k()(this,r);var t=(e=L()(this,W()(r).call(this))).constructor.instance;return t?L()(e,t):(e.constructor.instance=J()(e),e._user=Y,e)}return F()(r,e),U()(r,[{key:"signUp",value:function(e){var t,n;return a.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.a.awrap(new this._user(e).save());case 3:return t=s.sent,D.info("[UserManager - signUp] Successfully added user to the database"),n=M.signJWTToken(t._id),D.info("[UserManager - signUp] JWT created"),s.abrupt("return",{token:n,user:t.serialize()});case 10:throw s.prev=10,s.t0=s.catch(0),D.error("[UserManager - signUp] Unable to signup user: ".concat(s.t0.message)),r.parseError(s.t0,"User");case 14:case"end":return s.stop()}}),null,this,[[0,10]])}},{key:"login",value:function(e){var t,n;return a.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.a.awrap(this._user.findOne({email:e.email}).select("+password"));case 3:if(t=s.sent,D.info("[UserManager - login] get User from database"),s.t0=!t,s.t0){s.next=10;break}return s.next=9,a.a.awrap(t.correctPassword(e.password,t.password));case 9:s.t0=!s.sent;case 10:if(!s.t0){s.next=13;break}throw D.error("[UserManager - login] Incorrect email or password"),new ae("Incorrect email or password",401);case 13:return n=M.signJWTToken(t._id),s.abrupt("return",{token:n,user:t.serialize()});case 17:throw s.prev=17,s.t1=s.catch(0),D.error("[UserManager - login] Login failure: ".concat(s.t1.message)),r.parseError(s.t1,"User");case 21:case"end":return s.stop()}}),null,this,[[0,17]])}},{key:"forgotPassword",value:function(e,t){var n,s,o,c,u,i;return a.a.async((function(p){for(;;)switch(p.prev=p.next){case 0:return p.prev=0,p.next=3,a.a.awrap(this._user.findOne({email:e}));case 3:if(n=p.sent){p.next=7;break}throw D.error("[UserManager - forgotPassword] User not found"),new ae("User not found",404);case 7:return s=n.createPasswordResetToken(),p.next=10,a.a.awrap(n.save({validateBeforeSave:!1}));case 10:return o=t.host,c=t.protocol,u="".concat(c,"://").concat(o).concat(oe.BACKEND_BASEURL,"/reset-password/").concat(s),i="Forgot your password? Submit a PATCH request with your new password and passwordConfirm to ".concat(u,"\nIf you didn't forget your password, please ignore this email"),p.prev=13,p.next=16,a.a.awrap(te.shareInstance.sendEmail({email:n.email,subject:"Your password reset token is valid for 10mins",message:i}));case 16:p.next=26;break;case 18:return p.prev=18,p.t0=p.catch(13),n.passwordResetToken=void 0,n.passwordResetExpires=void 0,p.next=24,a.a.awrap(n.save({validateBeforeSave:!1}));case 24:throw D.error("[UserManager - forgotPassword] email failed: ".concat(p.t0.message)),new ae("Internal Server Failure",500);case 26:p.next=32;break;case 28:throw p.prev=28,p.t1=p.catch(0),D.error("[UserManager - forgotPassword] Forgot Password failure: ".concat(p.t1.message)),r.parseError(p.t1,"User");case 32:case"end":return p.stop()}}),null,this,[[0,28],[13,18]])}},{key:"resetPassword",value:function(e,t,n){var s,o,c;return a.a.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.prev=0,s=M.hashPasswordResetToken(e),u.next=4,a.a.awrap(Y.findOne({passwordResetToken:s,passwordResetExpires:{$gt:Date.now()}}));case 4:if(o=u.sent){u.next=8;break}throw D.error("[UserManager - resetPassword] Token is invalid or has expired"),new ae("Password Reset Token invalid or expired",400);case 8:return o.password=t,o.passwordConfirm=n,o.passwordResetToken=void 0,o.passwordResetExpires=void 0,u.next=14,a.a.awrap(o.save());case 14:return c=M.signJWTToken(o._id),u.abrupt("return",{token:c,user:o.serialize()});case 18:throw u.prev=18,u.t0=u.catch(0),D.error("[UserManager - resetPassword] Reset Password failure: ".concat(u.t0.message)),r.parseError(u.t0,"User");case 22:case"end":return u.stop()}}),null,null,[[0,18]])}},{key:"updatePassword",value:function(e,t,n,s){var o,c;return a.a.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.prev=0,u.next=3,a.a.awrap(this._user.findById(e).select("+password"));case 3:return o=u.sent,u.next=6,a.a.awrap(o.correctPassword(t,o.password));case 6:if(u.sent){u.next=9;break}throw D.error("[UserManager - updatePassword] Password no not match"),new ae("Incorrect Password",400);case 9:return o.password=n,o.passwordConfirm=s,u.next=13,a.a.awrap(o.save());case 13:return c=M.signJWTToken(o._id),u.abrupt("return",{token:c,user:o.serialize()});case 17:throw u.prev=17,u.t0=u.catch(0),D.error("[UserManager - updatePassword] Update Password failure: ".concat(u.t0.message)),r.parseError(u.t0,"User");case 21:case"end":return u.stop()}}),null,this,[[0,17]])}},{key:"updateUserInfo",value:function(e,t){var n;return a.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.a.awrap(this._user.findOneAndUpdate({_id:e},t,{new:!0,runValidators:!0}));case 3:return n=s.sent,s.abrupt("return",n.serialize());case 7:throw s.prev=7,s.t0=s.catch(0),D.error("[UserManager - updateUserInfo] Update User Info failure failure: ".concat(s.t0.message)),r.parseError(s.t0,"User");case 11:case"end":return s.stop()}}),null,this,[[0,7]])}},{key:"deactivateUser",value:function(e){return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.a.awrap(this._user.findByIdAndUpdate(e,{active:!1}));case 3:t.next=9;break;case 5:throw t.prev=5,t.t0=t.catch(0),D.error("[UserManager - deactivateUse] Deactivate User failure: ".concat(t.t0.message)),r.parseError(t.t0,"User");case 9:case"end":return t.stop()}}),null,this,[[0,5]])}},{key:"getUser",value:function(e){return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.abrupt("return",this._user.findById(e));case 4:throw t.prev=4,t.t0=t.catch(0),D.error("[UserManager - getUser] Get User failure: ".concat(t.t0.message)),r.parseError(t.t0,"User");case 8:case"end":return t.stop()}}),null,this,[[0,4]])}},{key:"getUsers",value:function(){var e;return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.a.awrap(this._user.find());case 3:if(e=t.sent){t.next=6;break}return t.abrupt("return",[]);case 6:return t.abrupt("return",e);case 9:throw t.prev=9,t.t0=t.catch(0),D.error("[UserManager - getUsers] Get Users failure: ".concat(t.t0.message)),r.parseError(t.t0,"User");case 13:case"end":return t.stop()}}),null,this,[[0,9]])}}],[{key:"shareInstance",get:function(){return void 0===this._sharedInstance&&(this._sharedInstance=new r),this._sharedInstance}}]),r}(se),ue=t(13),ie=t.n(ue),pe=t(28),de=t.n(pe),le=t(11),fe=t.n(le),he=t(17),we=t.n(he);function ve(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function me(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ve(Object(t),!0).forEach((function(r){ie()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ve(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var ge=["date-desc","date-asc","type-desc","type-asc","amount-desc","amount-asc"],ye=function(e){function r(){var e;k()(this,r);var t=(e=L()(this,W()(r).call(this))).constructor.instance;return t?L()(e,t):(e.constructor.instance=J()(e),e._transaction=Z,e)}return F()(r,e),U()(r,[{key:"addTransaction",value:function(e){var t;return a.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,a.a.awrap(new this._transaction(e).save());case 3:return t=n.sent,n.abrupt("return",t.serialize());case 7:throw n.prev=7,n.t0=n.catch(0),D.error("[TransactionManager - addTransaction] Error message: ".concat(n.t0.message)),r.parseError(n.t0,"Transaction");case 11:case"end":return n.stop()}}),null,this,[[0,7]])}},{key:"updateTransaction",value:function(e,t,n){var s;return a.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,a.a.awrap(this._transaction.findOneAndUpdate({_id:e,_user:t},n,{new:!0,runValidators:!0}));case 3:if(s=o.sent){o.next=7;break}throw D.error("[TransactionManager - updateTransaction] Transaction not found"),new ae("Transaction not found",404);case 7:return o.abrupt("return",s.serialize());case 10:throw o.prev=10,o.t0=o.catch(0),D.error("[TransactionManager - updateTransaction] Update Transaction error: ".concat(o.t0.message)),r.parseError(o.t0,"Transaction");case 14:case"end":return o.stop()}}),null,this,[[0,10]])}},{key:"deleteTransaction",value:function(e,t){return a.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,a.a.awrap(this._transaction.findOneAndDelete({_id:e,_user:t}));case 3:if(n.sent){n.next=7;break}throw D.error("[TransactionManager - DeleteTransaction] Transaction not found"),new ae("Transaction not found",404);case 7:n.next=13;break;case 9:throw n.prev=9,n.t0=n.catch(0),D.error("[TransactionManager - deleteTransaction] Delete Transaction error: ".concat(n.t0.message)),r.parseError(n.t0,"Transaction");case 13:case"end":return n.stop()}}),null,this,[[0,9]])}},{key:"getTransaction",value:function(e,t){var n;return a.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.a.awrap(this._transaction.findOne({_id:e,_user:t}));case 3:if(n=s.sent){s.next=7;break}throw D.error("[TransactionManager - getTransaction] Transaction not found"),new ae("Transaction not found",404);case 7:return s.abrupt("return",n.serialize());case 10:throw s.prev=10,s.t0=s.catch(0),D.error("[TransactionManager - getTransaction] Get Transaction error: ".concat(s.t0.message)),r.parseError(s.t0,"Transaction");case 14:case"end":return s.stop()}}),null,this,[[0,10]])}},{key:"getTransactions",value:function(e,t){var n,s,o,c,u,i,p,d,l,f,h,w,v,m,g,y,x,b,k;return a.a.async((function(T){for(;;)switch(T.prev=T.next){case 0:if(n=t.type,s=t.skip,o=void 0===s?0:s,c=t.limit,u=void 0===c?0:c,i=t.sort,p=void 0===i?"date-desc":i,T.prev=1,!n||"income"===n.toLowerCase()||"expense"===n.toLowerCase()){T.next=4;break}throw new ae("Invalid argument: type must be either income or expense",400);case 4:if(!isNaN(fe()(o))&&!isNaN(fe()(u))){T.next=6;break}throw new ae("Invalid argument: skip and limit must be numbers",400);case 6:if(ge.includes(p)){T.next=8;break}throw new ae("Invalid argument: sort must be one of date-desc, date-asc, type-desc, type-asc, amount-desc and amount-asc",400);case 8:return d=p.split("-"),l=de()(d,2),f=l[0],h=l[1],w=we()(fe()(o)),v=we()(fe()(u)),m={},n&&(m.type=n),T.next=15,a.a.awrap(this._transaction.find(me({_user:e},m)).sort(ie()({},f,h)).skip(fe()(w)).limit(fe()(v)));case 15:return g=T.sent,y=g.map((function(e){return e.serialize()})),T.next=19,a.a.awrap(this._transaction.countDocuments(me({_user:e},m)));case 19:return x=T.sent,(k=w+v)<x&&0!==k&&(b=k),T.abrupt("return",{typeCount:x,next:b,transactions:y,resultCount:y.length});case 25:throw T.prev=25,T.t0=T.catch(1),D.error("[TransactionManager - getTransactions] Get Transactions error: ".concat(T.t0.message)),r.parseError(T.t0,"Transaction");case 29:case"end":return T.stop()}}),null,this,[[1,25]])}},{key:"getSummary",value:function(){var e;return a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.a.awrap(this._transaction.aggregate().group({_id:"$type",total:{$sum:"$amount"}}));case 3:return e=t.sent,t.abrupt("return",this._formatSummary(e));case 7:throw t.prev=7,t.t0=t.catch(0),D.error("[TransactionManager - getSummary] Get Summary error: ".concat(t.t0.message)),r.parseError(t.t0,"Transaction");case 11:case"end":return t.stop()}}),null,this,[[0,7]])}},{key:"_formatSummary",value:function(e){var r={expense:0,income:0};return e.forEach((function(e){var t=e._id;void 0!==r[t]&&(r[t]=e.total)})),r.net=r.income-r.expense,r}}],[{key:"shareInstance",get:function(){return void 0===this._sharedInstance&&(this._sharedInstance=new r),this._sharedInstance}}]),r}(se);function xe(e,r,t){var n,s,o;return a.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?(n=e.headers.authorization.split(" ")[1],D.info("[Middleware - requireAuth] - Get Token from req Header")):e.cookies.jwt&&(n=e.cookies.jwt),n){r.next=5;break}throw D.error("[Middleware - requireAuth] - No Token in the request header"),new ae("No Token in the request header",401);case 5:return r.next=7,a.a.awrap(M.verifyJWTToken(n));case 7:return s=r.sent,r.next=10,a.a.awrap(ce.shareInstance.getUser(s.id));case 10:if(o=r.sent){r.next=14;break}throw D.error("[Middleware - requireAuth] - User no longer exists"),new ae("User no longer exists",401);case 14:if(!o.changePasswordAfter(s.iat)){r.next=17;break}throw D.error("[Middleware - requireAuth] - User recently changed password"),new ae("User recently changed password. Please log in again",401);case 17:e.user=o.serialize(),t(),r.next=25;break;case 21:r.prev=21,r.t0=r.catch(0),D.error("[Middleware - requireAuth] - Token Error - Incorrect or Expires"),t(r.t0);case 25:case"end":return r.stop()}}),null,null,[[0,21]])}var be=function(){function e(){k()(this,e)}return U()(e,null,[{key:"createSendToken",value:function(e,r,t,n){var a={expires:new Date(Date.now()+24*O.JWT_COOKIE_EXPIRES_IN*60*60*1e3),httpOnly:!0,secure:!0};n.cookie("jwt",r,a),n.status(t).json({statusCd:t,status:"success",token:r,data:{user:e}})}}]),e}();function ke(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function Te(e){for(var r=arguments.length,t=new Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];return t.reduce((function(r,t){return void 0!==e[t]?function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ke(Object(t),!0).forEach((function(r){ie()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ke(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}({},r,ie()({},t,e[t])):r}),{})}function Ue(e){return null==e||""===e}var _e=function(e){function r(){return k()(this,r),L()(this,W()(r).apply(this,arguments))}return F()(r,e),U()(r,null,[{key:"signUp",value:function(e,t,n){var s,o,c,u,i,p,d,l;return a.a.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,s=e.body,o=s.name,c=s.email,u=s.password,i=s.passwordConfirm,!(Ue(o)||Ue(c)||Ue(u)||Ue(i))){f.next=5;break}return D.error("[AuthController - signUp] Missing either name, email, password or passwordConfirm in request body"),f.abrupt("return",n(new ae("Invalid Arguments - Missing either name, email, password or passwordConfirm in request body",400)));case 5:return f.next=7,a.a.awrap(ce.shareInstance.signUp({name:o,email:c,password:u,passwordConfirm:i}));case 7:p=f.sent,d=p.token,l=p.user,D.info("[AuthController - signUp] SignUp success"),r.createSendToken(l,d,201,t),f.next=18;break;case 14:f.prev=14,f.t0=f.catch(0),D.error("[AuthController - signUp] SignUp request failed: ".concat(f.t0.message)),n(f.t0);case 18:case"end":return f.stop()}}),null,null,[[0,14]])}},{key:"login",value:function(e,t,n){var s,o,c,u,i,p;return a.a.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(d.prev=0,s=e.body,o=s.email,c=s.password,!Ue(o)&&!Ue(c)){d.next=5;break}return D.error("[AuthController - login] Missing email or password in request body"),d.abrupt("return",n(new ae("Invalid Arguments - Missing email or password in request body",400)));case 5:return d.next=7,a.a.awrap(ce.shareInstance.login({email:o,password:c}));case 7:u=d.sent,i=u.token,p=u.user,r.createSendToken(p,i,200,t),d.next=17;break;case 13:d.prev=13,d.t0=d.catch(0),D.error("[AuthController - Login] Login failed: ".concat(d.t0.message)),n(d.t0);case 17:case"end":return d.stop()}}),null,null,[[0,13]])}},{key:"logout",value:function(e,r){r.cookie("jwt","loggedOut",{expires:new Date(Date.now()+5e3),httpOnly:!0}),r.status(200).json({status:"success"})}},{key:"forgotPassword",value:function(e,r,t){var n,s,o;return a.a.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(c.prev=0,n=e.body.email,s=e.protocol,o=e.get("host"),!Ue(n)){c.next=7;break}return D.error("[AuthController - forgotPassword] Missing email in request body"),c.abrupt("return",t(new ae("Invalid Arguments - Missing email in request body",400)));case 7:return c.next=9,a.a.awrap(ce.shareInstance.forgotPassword(n,{host:o,protocol:s}));case 9:r.status(200).json({statusCd:200,status:"success",message:"Token sent to email"}),c.next=16;break;case 12:c.prev=12,c.t0=c.catch(0),D.error("[AuthController - forgotPassword] Forgot Password function failed: ".concat(c.t0.message)),t(c.t0);case 16:case"end":return c.stop()}}),null,null,[[0,12]])}},{key:"resetPassword",value:function(e,t,n){var s,o,c,u,i,p,d;return a.a.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(l.prev=0,s=e.params.token,o=e.body,c=o.password,u=o.passwordConfirm,!Ue(c)&&!Ue(u)){l.next=6;break}return D.error("[AuthController - resetPassword] Missing password or passwordConfirm in request body"),l.abrupt("return",n(new ae("Invalid Arguments - Missing password or passwordConfirm in request body",400)));case 6:return l.next=8,a.a.awrap(ce.shareInstance.resetPassword(s,c,u));case 8:i=l.sent,p=i.token,d=i.user,r.createSendToken(d,p,200,t),l.next=18;break;case 14:l.prev=14,l.t0=l.catch(0),D.error("[AuthController - resetPassword] reset password function failed: ".concat(l.t0.message)),n(l.t0);case 18:case"end":return l.stop()}}),null,null,[[0,14]])}}]),r}(be),Ie=function(e){function r(){return k()(this,r),L()(this,W()(r).apply(this,arguments))}return F()(r,e),U()(r,null,[{key:"getCurrentUser",value:function(e,r,t){var n;return a.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(!Ue(n=e.user)){a.next=4;break}return D.error("[UserController - getCurrentUser] User not found"),a.abrupt("return",t(new ae("User not found",404)));case 4:r.status(200).json({statusCd:200,status:"success",data:{user:n}});case 5:case"end":return a.stop()}}))}},{key:"getUsers",value:function(e,r,t){var n;return a.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.a.awrap(ce.shareInstance.getUsers());case 3:n=e.sent,r.status(200).json({statusCd:200,status:"success",data:{users:n}}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),D.error("[UserController - getUsers] Get Users failure: ".concat(e.t0.message)),t(e.t0);case 11:case"end":return e.stop()}}),null,null,[[0,7]])}},{key:"updatePassword",value:function(e,t,n){var s,o,c,u,i,p,d,l,f;return a.a.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(h.prev=0,s=e.body,o=s.password,c=s.newPassword,u=s.newPasswordConfirm,!Ue(i=e.user)){h.next=6;break}return D.error("[UserController - updatePassword] User not found"),h.abrupt("return",n(new ae("User not found",404)));case 6:if(p=i.id,!(Ue(o)||Ue(c)||Ue(u))){h.next=10;break}return D.error("[UserController - updatePassword] Missing either name, email, password or passwordConfirm in request body"),h.abrupt("return",n(new ae("Missing either name, email, password or passwordConfirm in request body",400)));case 10:return h.next=12,a.a.awrap(ce.shareInstance.updatePassword(p,o,c,u));case 12:d=h.sent,l=d.token,f=d.user,r.createSendToken(f,l,200,t),h.next=22;break;case 18:h.prev=18,h.t0=h.catch(0),D.error("[UserController - updatePassword] Update Password failure: ".concat(h.t0.message)),n(h.t0);case 22:case"end":return h.stop()}}),null,null,[[0,18]])}},{key:"updateUserInfo",value:function(e,r,t){var n,s,o,c;return a.a.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(u.prev=0,!e.body.password&&!e.body.passwordConfirm){u.next=3;break}return u.abrupt("return",t(new ae("This is route is not for password updates",400)));case 3:if(!Ue(n=e.user)){u.next=6;break}return u.abrupt("return",t(new ae("User not found",404)));case 6:return s=n.id,o=Te(e.body,"name","email"),u.next=10,a.a.awrap(ce.shareInstance.updateUserInfo(s,o));case 10:c=u.sent,r.status(200).json({statusCd:200,status:"success",data:{user:c}}),u.next=17;break;case 14:u.prev=14,u.t0=u.catch(0),t(u.t0);case 17:case"end":return u.stop()}}),null,null,[[0,14]])}},{key:"deleteCurrentUser",value:function(e,r,t){var n,s;return a.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(o.prev=0,!Ue(n=e.user)){o.next=4;break}return o.abrupt("return",t(new ae("User not found",404)));case 4:return s=n.id,o.next=7,a.a.awrap(ce.shareInstance.deactivateUser(s));case 7:r.status(204).json({statusCd:204,status:"success",data:null}),o.next=13;break;case 10:o.prev=10,o.t0=o.catch(0),t(o.t0);case 13:case"end":return o.stop()}}),null,null,[[0,10]])}}]),r}(be),Ee=function(){function e(){k()(this,e)}return U()(e,null,[{key:"handleError",value:function(e,r,t,n){e.statusCode=e.statusCode||500,e.status=e.status||"error",t.status(e.statusCode).json({statusCd:e.statusCode,status:e.status,message:e.message})}}]),e}(),Pe=function(){function e(){k()(this,e)}return U()(e,null,[{key:"addTransaction",value:function(e,r,t){var n,s,o,c,u,i,p,d,l;return a.a.async((function(f){for(;;)switch(f.prev=f.next){case 0:if(f.prev=0,!Ue(n=e.user)){f.next=4;break}return f.abrupt("return",t(new ae("User not found",404)));case 4:if(s=n.id,o=e.body,c=o.date,u=o.type,i=o.amount,p=o.description,!(Ue(c)||Ue(u)||Ue(i))){f.next=8;break}return f.abrupt("return",t(new ae("Missing either date, type, or amount in request body",400)));case 8:return d={date:c,type:u,amount:i,_user:s},p&&(d.description=p),f.next=12,a.a.awrap(ye.shareInstance.addTransaction(d));case 12:l=f.sent,r.status(201).json({statusCd:201,status:"success",data:{transaction:l}}),f.next=20;break;case 16:f.prev=16,f.t0=f.catch(0),D.error("[TransactionController - addTransaction] Add Transaction failure: ".concat(f.t0.message)),t(f.t0);case 20:case"end":return f.stop()}}),null,null,[[0,16]])}},{key:"updateTransaction",value:function(e,r,t){var n,s,o,c,u;return a.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,!Ue(n=e.user)){i.next=4;break}return i.abrupt("return",t(new ae("User not found",404)));case 4:return s=n.id,o=e.params.transactionId,c=Te(e.body,"date","type","amount","description"),i.next=9,a.a.awrap(ye.shareInstance.updateTransaction(o,s,c));case 9:u=i.sent,r.status(200).json({statusCd:200,status:"success",data:{transaction:u}}),i.next=17;break;case 13:i.prev=13,i.t0=i.catch(0),D.error("[TransactionController - updateTransaction] Update Transaction failure: ".concat(i.t0.message)),t(i.t0);case 17:case"end":return i.stop()}}),null,null,[[0,13]])}},{key:"getTransaction",value:function(e,r,t){var n,s,o,c;return a.a.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(u.prev=0,!Ue(n=e.user)){u.next=4;break}return u.abrupt("return",t(new ae("User not found",404)));case 4:return s=n.id,o=e.params.transactionId,u.next=8,a.a.awrap(ye.shareInstance.getTransaction(o,s));case 8:c=u.sent,r.status(200).json({statusCd:200,status:"success",data:{transaction:c}}),u.next=16;break;case 12:u.prev=12,u.t0=u.catch(0),D.error("[TransactionController - getTransaction] Get Transaction failure: ".concat(u.t0.message)),t(u.t0);case 16:case"end":return u.stop()}}),null,null,[[0,12]])}},{key:"deleteTransaction",value:function(e,r,t){var n,s,o;return a.a.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(c.prev=0,!Ue(n=e.user)){c.next=4;break}return c.abrupt("return",t(new ae("User not found",404)));case 4:return s=n.id,o=e.params.transactionId,c.next=8,a.a.awrap(ye.shareInstance.deleteTransaction(o,s));case 8:r.status(200).json({statusCd:200,status:"success"}),c.next=15;break;case 11:c.prev=11,c.t0=c.catch(0),D.error("[TransactionController - deleteTransaction] Delete Transaction failure: ".concat(c.t0.message)),t(c.t0);case 15:case"end":return c.stop()}}),null,null,[[0,11]])}},{key:"getTransactions",value:function(e,r,t){var n,s,o,c,u,i,p,d;return a.a.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(l.prev=0,!Ue(n=e.user)){l.next=4;break}return l.abrupt("return",t(new ae("User not found",404)));case 4:return s=n.id,o=Te(e.query,"type","skip","limit","sort"),l.next=8,a.a.awrap(ye.shareInstance.getTransactions(s,o));case 8:c=l.sent,u=c.typeCount,i=c.next,p=c.transactions,d=c.resultCount,r.status(200).json({statusCd:200,status:"success",data:{meta:{typeCount:u,next:i,resultCount:d},transactions:p}}),l.next=20;break;case 16:l.prev=16,l.t0=l.catch(0),D.error("[TransactionController - getTransactions] Get Transactions failure: ".concat(l.t0.message)),t(l.t0);case 20:case"end":return l.stop()}}),null,null,[[0,16]])}},{key:"getSummary",value:function(e,r,t){var n;return a.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.a.awrap(ye.shareInstance.getSummary());case 3:n=e.sent,r.status(200).json({statusCd:200,status:"success",summary:n}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),D.error("[TransactionController - getSummary] Get Summary failure: ".concat(e.t0.message)),t(e.t0);case 11:case"end":return e.stop()}}),null,null,[[0,7]])}}]),e}(),Ce=u.a.Router();Ce.post("/signup",_e.signUp),Ce.post("/login",_e.login),Ce.post("/logout",xe,_e.logout),Ce.post("/forgot_password",_e.forgotPassword),Ce.patch("/reset_password/:token",_e.resetPassword);var Oe=Ce,Me=u.a.Router();Me.use(xe),Me.get("/",function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return function(e,t,n){r.includes(e.user.role)?n():t.status(403).json({statusCd:403,status:"failure",message:"Unauthorized to use this route"})}}("admin"),Ie.getUsers),Me.get("/current_user",Ie.getCurrentUser),Me.patch("/current_user/password",Ie.updatePassword),Me.patch("/current_user/info",Ie.updateUserInfo),Me.delete("/current_user",Ie.deleteCurrentUser);var Se=Me,Ae=u.a.Router();Ae.use(xe),Ae.post("/",Pe.addTransaction),Ae.get("/",Pe.getTransactions),Ae.get("/summary",Pe.getSummary),Ae.patch("/:transactionId",Pe.updateTransaction),Ae.get("/:transactionId",Pe.getTransaction),Ae.delete("/:transactionId",Pe.deleteTransaction);var Re=Ae,qe=u.a.Router();qe.use("/auth",Oe),qe.use("/users",Se),qe.use("/transactions",Re);var je=qe,De=u.a.Router();De.all("*",(function(e,r,t){t(new ae("The ".concat(e.method," method on the ").concat(e.originalUrl," route does not exist on this server!"),404))}));var Ne=De,Le=u()();Le.use(l()());var Be=p()({max:100,windowMs:36e5,message:"Too many requests from this IP, please try again in an hour!"});Le.use(u.a.json({limit:"10kb"})),Le.use(x()()),Le.use(u.a.urlencoded({extended:!0})),Le.use(h()()),Le.use(v()()),Le.use(g()()),Le.use(oe.BACKEND_BASEURL,Be,je),Le.all("/api/*",Ne),Le.use(u.a.static("./client/build")),Le.get("*",(function(e,r){r.sendFile("./client/build/index.html")})),Le.use(Ee.handleError);o.a.connect(oe.MONGODB_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1}).then((function(){return a.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("Connected to database at ".concat(oe.MONGODB_URI)),Le.listen(oe.MONGODB_PORT,(function(){console.log("Server is running on PORT: ".concat(oe.MONGODB_PORT))}));case 2:case"end":return e.stop()}}))})).catch((function(e){console.error(e)}))}]);